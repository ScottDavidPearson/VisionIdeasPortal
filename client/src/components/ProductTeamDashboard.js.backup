import React, { useState, useEffect } from 'react';
import { DragDropContext, Draggable, Droppable } from '@hello-pangea/dnd';
import {
  AppBar,
  Toolbar,
  Typography,
  Button,
  Box,
  Grid,
  Card,
  CardContent,
  CardActions,
  Chip,
  Avatar,
  IconButton,
  Menu,
  MenuItem,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControl,
  InputLabel,
  Select,
  Paper,
  Collapse,
  Divider,
  Badge,
  Checkbox,
  Fab,
  Drawer,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  useTheme,
  useMediaQuery
} from '@mui/material';
import {
  Person as PersonIcon,
  Category as CategoryIcon,
  AttachFile as AttachIcon,
  ThumbUp as ThumbUpIcon,
  Logout as LogoutIcon,
  Dashboard as DashboardIcon,
  Visibility as ViewIcon,
  DragIndicator as DragIcon,
  Rocket as RocketIcon,
  Settings as SettingsIcon,
  Close as CloseIcon,
  Print as PrintIcon,
  FilterList as FilterIcon,
  Clear as ClearIcon,
  ExpandMore as ExpandMoreIcon,
  ExpandLess as ExpandLessIcon,
  CloudUpload as UploadIcon,
  Assignment as AssignmentIcon,
  Comment as CommentIcon,
  ViewModule as KanbanIcon,
  List as ListIcon,
  Sort as SortIcon,
  ArrowUpward as NewestIcon,
  ArrowDownward as OldestIcon,
  LocalParking as ParkingIcon
} from '@mui/icons-material';
import axios from 'axios';
import LinkifiedText from './LinkifiedText';
import AdminIdeaDetailDialog from './AdminIdeaDetailDialog';
import PromoteIdeaDialog from './PromoteIdeaDialog';
import SettingsDialog from './SettingsDialog';
import RoadmapReportDialog from './RoadmapReportDialog';
import ExcelImportDialog from './ExcelImportDialog';
import BulkCategoryDialog from './BulkCategoryDialog';
import CommentModal from './CommentModal';
import ThemeToggle from './ThemeToggle';

const statusColumns = {
  'submitted': {
    title: 'Submitted',
    color: '#1976d2',
    bgColor: '#e3f2fd'
  },
  'under_review': {
    title: 'Under Review',
    color: '#ed6c02',
    bgColor: '#fff3e0'
  },
  'approved': {
    title: 'Approved',
    color: '#2e7d32',
    bgColor: '#e8f5e8'
  },
  'in_progress': {
    title: 'In Progress',
    color: '#0288d1',
    bgColor: '#e1f5fe'
  },
  'completed': {
    title: 'Completed',
    color: '#388e3c',
    bgColor: '#f1f8e9'
  },
  'declined': {
    title: 'Parking Lot',
    color: '#f44336',
    bgColor: '#ffebee'
  }
};

const ProductTeamDashboard = ({ user, onLogout, onSwitchToPublic }) => {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('md'));
  const [showParkingLot, setShowParkingLot] = useState(false);
  const [ideas, setIdeas] = useState([]);
  const [allIdeas, setAllIdeas] = useState([]); // Store all ideas for filtering
  const [loading, setLoading] = useState(true);
  const [anchorEl, setAnchorEl] = useState(null);
  const [dragDisabled, setDragDisabled] = useState(false);
  const [selectedIdea, setSelectedIdea] = useState(null);
  const [promoteIdea, setPromoteIdea] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const [showRoadmapReport, setShowRoadmapReport] = useState(false);
  const [showExcelImport, setShowExcelImport] = useState(false);
  const [showFilters, setShowFilters] = useState(false);
  const [selectedIdeas, setSelectedIdeas] = useState([]);
  const [showBulkCategory, setShowBulkCategory] = useState(false);
  const [selectionMode, setSelectionMode] = useState(false);
  const [settings, setSettings] = useState({ productSuites: {} });
  const [commentCounts, setCommentCounts] = useState({});
  const [commentModalIdea, setCommentModalIdea] = useState(null);
  const [showCommentModal, setShowCommentModal] = useState(false);
  const [viewMode, setViewMode] = useState('kanban'); // 'kanban' or 'list'
  const [sortOrder, setSortOrder] = useState('newest'); // 'newest', 'oldest'
  
  // Filter state
  const [filters, setFilters] = useState({
    productSuite: '',
    module: '',
    status: '',
    source: '',
    tags: []
  });
  
  // Get all unique tags from ideas
  const getAllTags = () => {
    const tagSet = new Set();
    allIdeas.forEach(idea => {
      if (idea.tags && Array.isArray(idea.tags)) {
        idea.tags.forEach(tag => tagSet.add(tag));
      }
    });
    return Array.from(tagSet).sort();
  };

  useEffect(() => {
    fetchIdeas();
    fetchSettings();
  }, []);

  const fetchCommentCounts = async (ideaIds) => {
    try {
      if (!ideaIds || ideaIds.length === 0) return;
      
      const response = await axios.post('/api/ideas/comment-counts', {
        ideaIds: ideaIds
      });
      
      if (response.data.success) {
        setCommentCounts(response.data.commentCounts);
      }
    } catch (error) {
      console.error('Error fetching comment counts:', error);
    }
  };

  const fetchSettings = async () => {
    try {
      const response = await axios.get('/api/admin/settings', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
        }
      });
      
      if (response.data.success) {
        setSettings(response.data.settings);
        console.log('Loaded settings for filters:', response.data.settings);
      }
    } catch (error) {
      console.error('Error fetching settings:', error);
    }
  };

  const fetchIdeas = async () => {
    try {
      const response = await axios.get('/api/admin/ideas', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
        }
      });
      
      if (response.data.success) {
        console.log(`Fetched ${response.data.ideas.length} ideas for admin dashboard`);
        console.log('Status breakdown:', response.data.statusBreakdown);
        
        // Filter out any invalid ideas
        const validIdeas = response.data.ideas.filter(idea => idea && idea.id);
        console.log(`Filtered to ${validIdeas.length} valid ideas`);
        
        setAllIdeas(validIdeas);
        setIdeas(validIdeas); // Initially show all ideas
        
        // Fetch comment counts for all ideas
        const ideaIds = validIdeas.map(idea => idea.id);
        await fetchCommentCounts(ideaIds);
      } else {
        console.error('Failed to fetch ideas:', response.data.error);
      }
    } catch (error) {
      console.error('Error fetching ideas:', error);
    } finally {
      setLoading(false);
    }
  };

  // Filter ideas based on current filters
  useEffect(() => {
    let filtered = [...allIdeas];

    console.log('Filtering ideas:', {
      totalIdeas: allIdeas.length,
      filters: filters,
      sampleCategories: allIdeas.slice(0, 3).map(idea => ({ id: idea.id, category: idea.category }))
    });

    if (filters.productSuite) {
      console.log(`Filtering by product suite: "${filters.productSuite}"`);
      filtered = filtered.filter(idea => {
        const [suite] = idea.category?.split(' - ') || [''];
        const matches = suite === filters.productSuite;
        if (!matches && idea.category) {
          console.log(`Idea ${idea.id} category "${idea.category}" -> suite "${suite}" doesn't match "${filters.productSuite}"`);
        }
        return matches;
      });
      console.log(`After product suite filter: ${filtered.length} ideas`);
    }

    if (filters.module) {
      console.log(`Filtering by module: "${filters.module}"`);
      filtered = filtered.filter(idea => {
        const [, module] = idea.category?.split(' - ') || ['', ''];
        const matches = module === filters.module;
        if (!matches && idea.category) {
          console.log(`Idea ${idea.id} category "${idea.category}" -> module "${module}" doesn't match "${filters.module}"`);
        }
        return matches;
      });
      console.log(`After module filter: ${filtered.length} ideas`);
    }

    if (filters.status) {
      filtered = filtered.filter(idea => idea.status === filters.status);
    }

    if (filters.source) {
      filtered = filtered.filter(idea => idea.source === filters.source);
    }

    // Filter by tags (all selected tags must match)
    if (filters.tags && filters.tags.length > 0) {
      filtered = filtered.filter(idea => 
        idea.tags && 
        filters.tags.every(tag => idea.tags.includes(tag))
      );
    }

    console.log(`Final filtered ideas: ${filtered.length}`);
    setIdeas(filtered);
  }, [allIdeas, filters]);

  // Get unique product suites and modules
  // Get product suites from settings configuration
  const getProductSuites = () => {
    if (settings.productSuites && Object.keys(settings.productSuites).length > 0) {
      return Object.keys(settings.productSuites).sort();
    }
    // Fallback to extracting from ideas if no settings
    const suites = new Set();
    allIdeas.forEach(idea => {
      if (idea.category) {
        const [suite] = idea.category.split(' - ');
        if (suite) suites.add(suite);
      }
    });
    return Array.from(suites).sort();
  };

  // Get modules from settings configuration for selected suite
  const getModules = () => {
    if (settings.productSuites && filters.productSuite && settings.productSuites[filters.productSuite]) {
      return settings.productSuites[filters.productSuite].sort();
    }
    // Fallback to extracting from ideas if no settings
    const modules = new Set();
    allIdeas.forEach(idea => {
      if (idea.category && (!filters.productSuite || idea.category.startsWith(filters.productSuite))) {
        const [, module] = idea.category.split(' - ');
        if (module) modules.add(module);
      }
    });
    return Array.from(modules).sort();
  };

  const getSources = () => {
    // Use configured sources from settings if available
    if (settings.sources && settings.sources.length > 0) {
      return settings.sources.sort();
    }
    
    // Fallback to extracting from ideas if no settings
    const sources = new Set();
    allIdeas.forEach(idea => {
      if (idea.source) sources.add(idea.source);
    });
    return Array.from(sources).sort();
  };

  const handleFilterChange = (filterType, value) => {
    setFilters(prev => ({
      ...prev,
      [filterType]: value,
      // Clear module filter if product suite changes
      ...(filterType === 'productSuite' && { module: '' })
    }));
  };

  const clearFilters = () => {
    setFilters({
      productSuite: '',
      module: '',
      status: '',
      source: '',
      tags: []
    });
  };

  // Bulk selection functions
  const toggleSelectionMode = () => {
    setSelectionMode(!selectionMode);
    setSelectedIdeas([]);
  };

  const toggleIdeaSelection = (idea) => {
    setSelectedIdeas(prev => {
      const isSelected = prev.some(selected => selected.id === idea.id);
      if (isSelected) {
        return prev.filter(selected => selected.id !== idea.id);
      } else {
        return [...prev, idea];
      }
    });
  };

  const selectAllIdeas = () => {
    setSelectedIdeas([...ideas]);
  };

  const clearSelection = () => {
    setSelectedIdeas([]);
  };

  const handleBulkCategorySuccess = () => {
    setShowBulkCategory(false);
    setSelectedIdeas([]);
    setSelectionMode(false);
    fetchIdeas(); // Refresh the ideas list
  };


  const handleDragStart = (start) => {
    console.log('Drag started:', start);
    setDragDisabled(false);
  };

  const handleDragUpdate = (update) => {
    console.log('Drag update:', update);
  };

  const handleDragEnd = async (result) => {
    console.log('Drag ended:', result);
    const { destination, source, draggableId } = result;

    // If no destination, return
    if (!destination) {
      console.log('No destination - drag cancelled');
      return;
    }

    // If dropped in same position, return
    if (destination.droppableId === source.droppableId && destination.index === source.index) {
      console.log('Dropped in same position');
      return;
    }

    // Check if dropping on the parking lot tab
    if (destination.droppableId === 'parking_lot_tab') {
      const ideaId = parseInt(draggableId.replace('idea-', ''));
      
      // Optimistically update the UI first
      setAllIdeas(prevIdeas => 
        prevIdeas.map(idea => 
          idea.id === ideaId 
            ? { ...idea, status: 'parking_lot', updatedAt: new Date().toISOString() }
            : idea
        )
      );

      try {
        const response = await axios.put(`/api/admin/ideas/${ideaId}/status`, 
          { status: 'parking_lot' },
          {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
            }
          }
        );

        if (response.data.success) {
          console.log('Moved to parking lot successfully');
          // Open the parking lot drawer
          setShowParkingLot(true);
          // Show success message
          setSnackbar({
            open: true,
            message: 'Idea moved to Parking Lot',
            severity: 'success'
          });
        } else {
          console.error('Failed to move to parking lot:', response.data.error);
          // Revert the optimistic update
          setAllIdeas(prevIdeas => 
            prevIdeas.map(idea => 
              idea.id === ideaId 
                ? { ...idea, status: source.droppableId }
                : idea
            )
          );
        }
      } catch (error) {
        console.error('Error moving to parking lot:', error);
        // Revert the optimistic update
        setIdeas(prevIdeas => 
          prevIdeas.map(idea => 
            idea.id === ideaId 
              ? { ...idea, status: source.droppableId }
              : idea
          )
        );
        setSnackbar({
          open: true,
          message: 'Failed to move idea to Parking Lot',
          severity: 'error'
        });
      }
      return;
    }

    // Handle regular column drops
    const newStatus = destination.droppableId;
    const ideaId = parseInt(draggableId.replace('idea-', ''));
    
    console.log(`Moving idea ${ideaId} from ${source.droppableId} to ${newStatus}`);

    // Optimistically update the UI first
    setAllIdeas(prevIdeas => 
      prevIdeas.map(idea => 
        idea.id === ideaId 
          ? { ...idea, status: newStatus, updatedAt: new Date().toISOString() }
          : idea
      )
    );

    try {
      const response = await axios.put(`/api/admin/ideas/${ideaId}/status`, 
        { status: newStatus },
        {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
          }
        }
      );

      if (response.data.success) {
        console.log('Status updated successfully');
        // Ensure the local state is updated with the server response
        setAllIdeas(prevIdeas => 
          prevIdeas.map(idea => 
            idea.id === ideaId 
              ? { ...idea, status: newStatus, updatedAt: new Date().toISOString(), updatedBy: 'admin' }
              : idea
          )
        );
      } else {
        console.error('Failed to update status:', response.data.error);
        // Revert the optimistic update
        setIdeas(prevIdeas => 
          prevIdeas.map(idea => 
            idea.id === ideaId 
              ? { ...idea, status: source.droppableId }
              : idea
          )
        );
      }
    } catch (error) {
      console.error('Error updating idea status:', error);
      // Revert the optimistic update
      setAllIdeas(prevIdeas => 
        prevIdeas.map(idea => 
          idea.id === ideaId 
            ? { ...idea, status: source.droppableId }
            : idea
        )
      );
    }
  };

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric'
    });
  };

  const getIdeasByStatus = (status) => {
    const filteredIdeas = ideas.filter(idea => idea && idea.id && idea.status === status);
    
    // Sort ideas by creation date
    return filteredIdeas.sort((a, b) => {
      const dateA = new Date(a.createdAt);
      const dateB = new Date(b.createdAt);
      
      if (sortOrder === 'newest') {
        return dateB - dateA; // Newest first
      } else {
        return dateA - dateB; // Oldest first
      }
    });
  };

  const handleMenuOpen = (event) => {
    setAnchorEl(event.currentTarget);
  };

  const handleMenuClose = () => {
    setAnchorEl(null);
  };

  const handleLogout = () => {
    localStorage.removeItem('adminToken');
    localStorage.removeItem('adminUser');
    handleMenuClose();
    onLogout();
  };

  const handleIdeaUpdated = (updatedIdea) => {
    console.log('Idea updated:', updatedIdea);
    
    // If updatedIdea is null or undefined, it means the idea was deleted
    if (!updatedIdea || !updatedIdea.id) {
      console.log('Idea was deleted, refreshing from server');
      fetchIdeas();
      return;
    }
    
    // Always refresh from server to ensure we have the latest data including priority
    console.log('Refreshing ideas from server to get latest data including priority');
    fetchIdeas();
  };

  const handleCardClick = (idea, event) => {
    // Don't open dialog if clicking on drag handle or promote button
    if (event.target.closest('[data-rbd-drag-handle-draggable-id]') || 
        event.target.closest('.promote-button')) {
      return;
    }
    setSelectedIdea(idea);
  };

  const handlePromoteClick = (idea, event) => {
    event.stopPropagation(); // Prevent card click
    setPromoteIdea(idea);
  };

  const handleIdeaPromoted = (promotedIdea) => {
    setIdeas(prevIdeas => 
      prevIdeas.map(idea => 
        idea.id === promotedIdea.id ? promotedIdea : idea
      )
    );
  };

  const handleSettingsUpdated = (newSettings) => {
    // Refresh both settings and ideas when settings are updated
    console.log('Settings updated:', newSettings);
    fetchSettings(); // Refresh settings for filters
    fetchIdeas(); // Refresh ideas in case categories changed
  };

  if (loading) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center" minHeight="100vh">
        <Typography>Loading dashboard...</Typography>
      </Box>
    );
  }

  const renderMainContent = () => (
    <Box sx={{ flexGrow: 1, minHeight: '100vh', backgroundColor: 'background.default' }}>
      {/* Header */}
      <AppBar position="static" elevation={1}>
        <Toolbar>
          <DashboardIcon sx={{ mr: 2 }} />
          <Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
            Product Team Dashboard
          </Typography>
          <Button 
            color="inherit" 
            onClick={onSwitchToPublic}
            startIcon={<ViewIcon />}
            sx={{ mr: 2 }}
          >
            Public View
          </Button>
          <IconButton
            color="inherit"
            onClick={() => setShowFilters(!showFilters)}
            sx={{ mr: 1 }}
            title="Filters"
          >
            <FilterIcon />
          </IconButton>
          
          {/* View Mode Toggle */}
          <Box sx={{ display: 'flex', mr: 1, border: '1px solid rgba(255,255,255,0.3)', borderRadius: 1 }}>
            <IconButton
              color={viewMode === 'kanban' ? 'primary' : 'inherit'}
              onClick={() => setViewMode('kanban')}
              size="small"
              title="Kanban View"
              sx={{ 
                borderRadius: '4px 0 0 4px',
                backgroundColor: viewMode === 'kanban' ? 'rgba(255,255,255,0.2)' : 'transparent'
              }}
            >
              <KanbanIcon />
            </IconButton>
            <IconButton
              color={viewMode === 'list' ? 'primary' : 'inherit'}
              onClick={() => setViewMode('list')}
              size="small"
              title="List View"
              sx={{ 
                borderRadius: '0 4px 4px 0',
                backgroundColor: viewMode === 'list' ? 'rgba(255,255,255,0.2)' : 'transparent'
              }}
            >
              <ListIcon />
            </IconButton>
          </Box>
          
          {/* Sort Order Toggle */}
          <IconButton
            color="inherit"
            onClick={() => setSortOrder(sortOrder === 'newest' ? 'oldest' : 'newest')}
            sx={{ mr: 1 }}
            title={`Sort by ${sortOrder === 'newest' ? 'Oldest First' : 'Newest First'}`}
          >
            {sortOrder === 'newest' ? <NewestIcon /> : <OldestIcon />}
          </IconButton>
          
          <IconButton
            color="inherit"
            onClick={() => setShowSettings(true)}
            sx={{ mr: 1 }}
            title="Settings"
          >
            <SettingsIcon />
          </IconButton>
          <IconButton
            color="inherit"
            onClick={() => setShowExcelImport(true)}
            sx={{ mr: 1 }}
            title="Import Ideas from Excel"
          >
            <UploadIcon />
          </IconButton>
          <IconButton
            color="inherit"
            onClick={() => setShowRoadmapReport(true)}
            sx={{ mr: 2 }}
            title="Generate Roadmap Report"
          >
            <PrintIcon />
          </IconButton>
          
          {/* Theme Toggle */}
          <ThemeToggle />
          
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <Typography variant="body2">
              Welcome, {user.name}
            </Typography>
            <IconButton
              color="inherit"
              onClick={handleMenuOpen}
            >
              <Avatar sx={{ width: 32, height: 32, bgcolor: 'secondary.main' }}>
                {user.name.charAt(0).toUpperCase()}
              </Avatar>
            </IconButton>
          </Box>
        </Toolbar>
      </AppBar>

      <Menu
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={handleMenuClose}
      >
        <MenuItem onClick={handleLogout}>
          <LogoutIcon sx={{ mr: 1 }} />
          Logout
        </MenuItem>
      </Menu>

      {/* Filter Panel */}
      <Collapse in={showFilters}>
        <Paper sx={{ m: 2, p: 2, backgroundColor: 'background.paper' }}>
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
            <FilterIcon sx={{ mr: 1 }} />
            <Typography variant="h6">Filters</Typography>
            <Box sx={{ flexGrow: 1 }} />
            <Button
              size="small"
              onClick={clearFilters}
              startIcon={<ClearIcon />}
              disabled={!filters.productSuite && !filters.module && !filters.status && !filters.source && (!filters.tags || filters.tags.length === 0)}
            >
              Clear All
            </Button>
          </Box>
          
          <Grid container spacing={2}>
            <Grid item xs={12} sm={6} md={3}>
              <FormControl fullWidth size="small">
                <InputLabel>Product Suite</InputLabel>
                <Select
                  value={filters.productSuite}
                  label="Product Suite"
                  onChange={(e) => handleFilterChange('productSuite', e.target.value)}
                >
                  <MenuItem value="">All Suites</MenuItem>
                  {getProductSuites().map(suite => (
                    <MenuItem key={suite} value={suite}>{suite}</MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
            
            <Grid item xs={12} sm={6} md={3}>
              <FormControl fullWidth size="small">
                <InputLabel>Module</InputLabel>
                <Select
                  value={filters.module}
                  label="Module"
                  onChange={(e) => handleFilterChange('module', e.target.value)}
                  disabled={!filters.productSuite}
                >
                  <MenuItem value="">All Modules</MenuItem>
                  {getModules().map(module => (
                    <MenuItem key={module} value={module}>{module}</MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
            
            <Grid item xs={12} sm={6} md={3}>
              <FormControl fullWidth size="small">
                <InputLabel>Status</InputLabel>
                <Select
                  value={filters.status}
                  label="Status"
                  onChange={(e) => handleFilterChange('status', e.target.value)}
                >
                  <MenuItem value="">All Statuses</MenuItem>
                  {Object.entries(statusColumns).map(([status, config]) => (
                    <MenuItem key={status} value={status}>{config.title}</MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
            
            <Grid item xs={12} sm={6} md={3}>
              <FormControl fullWidth size="small">
                <InputLabel>Source</InputLabel>
                <Select
                  value={filters.source}
                  label="Source"
                  onChange={(e) => handleFilterChange('source', e.target.value)}
                >
                  <MenuItem value="">All Sources</MenuItem>
                  {getSources().map(source => (
                    <MenuItem key={source} value={source}>{source}</MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
            
            <Grid item xs={12}>
              <FormControl fullWidth size="small">
                <InputLabel>Tags</InputLabel>
                <Select
                  multiple
                  value={filters.tags || []}
                  onChange={(e) => handleFilterChange('tags', e.target.value)}
                  label="Tags"
                  renderValue={(selected) => (
                    <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                      {selected.map((value) => (
                        <Chip key={value} label={value} size="small" />
                      ))}
                    </Box>
                  )}
                >
                  {getAllTags().map((tag) => (
                    <MenuItem key={tag} value={tag}>
                      <Checkbox checked={filters.tags?.includes(tag) || false} />
                      {tag}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
          </Grid>
          
          {/* Active Filters Display */}
          {(filters.productSuite || filters.module || filters.status || filters.source || (filters.tags && filters.tags.length > 0)) && (
            <Box sx={{ mt: 2 }}>
              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                Active Filters:
              </Typography>
              <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
                {filters.productSuite && (
                  <Chip 
                    label={`Suite: ${filters.productSuite}`} 
                    size="small" 
                    onDelete={() => handleFilterChange('productSuite', '')}
                  />
                )}
                {filters.module && (
                  <Chip 
                    label={`Module: ${filters.module}`} 
                    size="small" 
                    onDelete={() => handleFilterChange('module', '')}
                  />
                )}
                {filters.status && (
                  <Chip 
                    label={`Status: ${statusColumns[filters.status]?.title || filters.status}`} 
                    size="small" 
                    onDelete={() => handleFilterChange('status', '')}
                  />
                )}
                {filters.source && (
                  <Chip 
                    label={`Source: ${filters.source}`} 
                    size="small" 
                    onDelete={() => handleFilterChange('source', '')}
                  />
                )}
                {filters.tags && filters.tags.length > 0 && (
                  filters.tags.map(tag => (
                    <Chip 
                      key={tag} 
                      label={`Tag: ${tag}`} 
                      size="small" 
                      onDelete={() => handleFilterChange('tags', filters.tags.filter(t => t !== tag))}
                    />
                  ))
                )}
              </Box>
            </Box>
          )}
          
          {/* Item Count Display */}
          <Box sx={{ 
            mt: 2, 
            p: 2, 
            backgroundColor: 'primary.50', 
            borderRadius: 1,
            border: '1px solid',
            borderColor: 'primary.200'
          }}>
            <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <Typography variant="h6" color="primary.main" sx={{ fontWeight: 'bold' }}>
                  {ideas.length}
                </Typography>
                <Typography variant="body1" color="text.primary">
                  {ideas.length === 1 ? 'item' : 'items'} to manage
                </Typography>
              </Box>
              <Typography variant="body2" color="text.secondary">
                of {allIdeas.length} total
              </Typography>
            </Box>
            {ideas.length !== allIdeas.length && (
              <Typography variant="caption" color="text.secondary" sx={{ mt: 0.5, display: 'block' }}>
                Filtered from {allIdeas.length} total ideas
              </Typography>
            )}
          </Box>
        </Paper>
      </Collapse>

      {/* Main Content Area */}
      <Box sx={{ 
        p: 3, 
        mr: showParkingLot && !isMobile ? '320px' : 0,
        transition: theme.transitions.create('margin', {
          easing: theme.transitions.easing.easeOut,
          duration: theme.transitions.duration.enteringScreen,
        }),
      }}>
        <Typography variant="h5" gutterBottom>
          Ideas Management - {viewMode === 'kanban' ? 'Kanban Board' : 'List View'}
        </Typography>
        <Typography variant="body2" color="text.secondary" paragraph>
          {viewMode === 'kanban' 
            ? 'Drag and drop ideas between columns to change their status'
            : 'View and manage all ideas in a comprehensive list format'
          }
        </Typography>

        <Box>
          <Grid container spacing={2} sx={{ 
            display: 'flex',
            justifyContent: 'space-between',
            flexWrap: 'nowrap',
            overflowX: 'auto',
            padding: '8px 0',
            '& > .MuiGrid-item': {
              flex: '1 1 0',
              minWidth: '280px',
              maxWidth: 'none',
              padding: '0 8px'
            }
          }}>
            {Object.entries(statusColumns).map(([status, config]) => {
              // Skip declined status as it will be in the drawer
              if (status === 'declined') return null;
              const statusIdeas = getIdeasByStatus(status);
              
              return (
                <Grid item key={status}>
                  <Paper 
                    sx={{ 
                      p: 2, 
                      minHeight: '70vh',
                      backgroundColor: 'background.paper',
                      border: `2px solid ${config.color}20`,
                      borderLeft: `4px solid ${config.color}`
                    }}
                  >
                    <Box sx={{ mb: 2, display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Typography variant="h6" sx={{ color: config.color }}>
                          {config.title}
                        </Typography>
                        <Badge badgeContent={statusIdeas.length} color="primary" />
                      </Box>
                      <Box sx={{ display: 'flex', alignItems: 'center' }}>
                        <IconButton
                          size="small"
                          onClick={() => setSortOrder(sortOrder === 'newest' ? 'oldest' : 'newest')}
                          title={`Sort by ${sortOrder === 'newest' ? 'Oldest First' : 'Newest First'}`}
                          sx={{ 
                            color: config.color, 
                            opacity: 0.7,
                            '&:hover': { 
                              opacity: 1,
                              backgroundColor: `${config.color}20`
                            }
                          }}
                        >
                          {sortOrder === 'newest' ? (
                            <NewestIcon fontSize="small" />
                          ) : (
                            <OldestIcon fontSize="small" />
                          )}
                        </IconButton>
                      </Box>
                    </Box>

                    <Droppable droppableId={status} type="CARD">
                      {(provided, snapshot) => (
                        <Box
                          ref={provided.innerRef}
                          {...provided.droppableProps}
                          sx={{
                            minHeight: '60vh',
                            backgroundColor: snapshot.isDraggingOver ? 'rgba(25, 118, 210, 0.1)' : 'transparent',
                            border: snapshot.isDraggingOver ? '2px dashed #1976d2' : '2px dashed transparent',
                            borderRadius: 2,
                            transition: 'all 0.2s ease',
                            p: 1
                          }}
                        >
                          {snapshot.isDraggingOver && (
                            <Box sx={{ 
                              textAlign: 'center', 
                              py: 2, 
                              color: 'primary.main',
                              fontWeight: 'bold'
                            }}>
                              Drop here to move to {config.title}
                            </Box>
                          )}
                          {statusIdeas.filter(idea => idea && idea.id).map((idea, index) => (
                            <Draggable 
                              key={`idea-${idea.id}`} 
                              draggableId={`idea-${idea.id}`} 
                              index={index}
                              isDragDisabled={dragDisabled}
                            >
                              {(provided, snapshot) => (
                                viewMode === 'kanban' ? (
                                  <Card
                                    ref={provided.innerRef}
                                    {...provided.draggableProps}
                                    onClick={(e) => handleCardClick(idea, e)}
                                    sx={{
                                      mb: 2,
                                      cursor: snapshot.isDragging ? 'grabbing' : 'pointer',
                                      transform: snapshot.isDragging ? 'rotate(3deg) scale(1.02)' : 'none',
                                      boxShadow: snapshot.isDragging ? 8 : 2,
                                      opacity: snapshot.isDragging ? 0.9 : 1,
                                      border: snapshot.isDragging ? '2px solid #1976d2' : '1px solid #e0e0e0',
                                      transition: snapshot.isDragging ? 'none' : 'all 0.2s ease',
                                      '&:hover': {
                                        boxShadow: 4,
                                        transform: 'translateY(-2px)'
                                      },
                                      userSelect: 'none'
                                    }}
                                  >
                                  <CardContent sx={{ p: 0, position: 'relative' }}>
                                    {/* Category - Full width and prominent at top */}
                                    {idea.category ? (
                                      <Box
                                        {...provided.dragHandleProps}
                                        sx={{
                                          position: 'absolute',
                                          top: 0,
                                          left: 0,
                                          right: 0,
                                          backgroundColor: 'primary.main',
                                          color: 'primary.contrastText',
                                          px: 1,
                                          py: 0.25,
                                          textAlign: 'center',
                                          fontWeight: 600,
                                          fontSize: '0.6rem',
                                          textTransform: 'uppercase',
                                          letterSpacing: 0.3,
                                          whiteSpace: 'nowrap',
                                          overflow: 'hidden',
                                          textOverflow: 'ellipsis',
                                          boxShadow: 1,
                                          border: '2px solid',
                                          borderColor: 'primary.dark',
                                          borderRadius: '4px 4px 0 0',
                                          zIndex: 1,
                                          cursor: 'grab',
                                          '&:active': {
                                            cursor: 'grabbing'
                                          }
                                        }}
                                      >
                                        {idea.category ? idea.category.split(' - ').pop() : ''}
                                      </Box>
                                    ) : (
                                      <Box
                                        {...provided.dragHandleProps}
                                        sx={{
                                          position: 'absolute',
                                          top: 0,
                                          left: 0,
                                          right: 0,
                                          backgroundColor: 'warning.light',
                                          color: 'warning.contrastText',
                                          px: 1,
                                          py: 0.25,
                                          textAlign: 'center',
                                          fontWeight: 600,
                                          fontSize: '0.6rem',
                                          textTransform: 'uppercase',
                                          letterSpacing: 0.3,
                                          whiteSpace: 'nowrap',
                                          overflow: 'hidden',
                                          textOverflow: 'ellipsis',
                                          boxShadow: 1,
                                          border: '2px dashed',
                                          borderColor: 'warning.main',
                                          opacity: 0.8,
                                          borderRadius: '4px 4px 0 0',
                                          zIndex: 1,
                                          cursor: 'grab',
                                          '&:active': {
                                            cursor: 'grabbing'
                                          }
                                        }}
                                      >
                                        ‚ö†Ô∏è NO CATEGORY
                                      </Box>
                                    )}

                                    {/* Content with padding and top margin for category */}
                                    <Box sx={{ p: 1.5, pt: 4.5 }}>
                                      {/* Title and Engagement Badges */}
                                      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 1 }}>
                                        <Typography 
                                          variant="subtitle2" 
                                          component="h3" 
                                          sx={{ 
                                            fontWeight: 600, 
                                            flexGrow: 1, 
                                            mr: 1,
                                            fontSize: '0.8rem',
                                            lineHeight: 1.3,
                                            display: '-webkit-box',
                                            WebkitLineClamp: 2,
                                            WebkitBoxOrient: 'vertical',
                                            overflow: 'hidden'
                                          }}
                                        >
                                          {idea.title}
                                        </Typography>
                                        
                                        {/* New indicator for recent ideas */}
                                        {(() => {
                                          const createdDate = new Date(idea.createdAt);
                                          const now = new Date();
                                          const daysDiff = (now - createdDate) / (1000 * 60 * 60 * 24);
                                          return daysDiff <= 3;
                                        })() && (
                                          <Chip 
                                            label="New" 
                                            size="small" 
                                            color="info"
                                            sx={{ 
                                              fontSize: '0.6rem', 
                                              height: '16px',
                                              ml: 0.5
                                            }} 
                                          />
                                        )}
                                      </Box>

                                      {/* Description */}
                                      <Box sx={{ mb: 1 }}>
                                        <Typography 
                                          variant="body2" 
                                          color="text.secondary"
                                          sx={{ 
                                            display: '-webkit-box',
                                            WebkitLineClamp: 2,
                                            WebkitBoxOrient: 'vertical',
                                            overflow: 'hidden',
                                            fontSize: '0.75rem',
                                            lineHeight: 1.3
                                          }}
                                        >
                                          {idea.description}
                                        </Typography>
                                      </Box>

                                      {/* Notes Display in Kanban */}
                                      {idea.notes && idea.notes.trim() && (
                                        <Box sx={{ 
                                          mb: 0.75, 
                                          p: 0.75, 
                                          backgroundColor: 'info.50', 
                                          borderRadius: 0.5,
                                          borderLeft: '2px solid',
                                          borderLeftColor: 'info.main'
                                        }}>
                                          <Typography variant="caption" color="info.main" sx={{ 
                                            fontWeight: 'bold', 
                                            display: 'block', 
                                            fontSize: '0.65rem',
                                            mb: 0.25
                                          }}>
                                            üìù Notes:
                                          </Typography>
                                          <Typography 
                                            variant="caption" 
                                            color="text.secondary"
                                            sx={{ 
                                              fontSize: '0.65rem',
                                              lineHeight: 1.2,
                                              display: '-webkit-box',
                                              WebkitLineClamp: 2,
                                              WebkitBoxOrient: 'vertical',
                                              overflow: 'hidden'
                                            }}
                                          >
                                            {idea.notes}
                                          </Typography>
                                        </Box>
                                      )}

                                      <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.25, mb: 0.75 }}>
                                        <Chip 
                                          label={idea.source}
                                          size="small"
                                          color="secondary"
                                          variant="outlined"
                                          sx={{ fontSize: '0.65rem', height: '20px' }}
                                        />
                                        
                                        {/* Priority Indicator */}
                                        <Chip 
                                          label={`${(idea.priority || 'medium').charAt(0).toUpperCase() + (idea.priority || 'medium').slice(1)} Priority`}
                                          size="small"
                                          color={(idea.priority || 'medium') === 'high' ? 'error' : (idea.priority || 'medium') === 'low' ? 'default' : 'warning'}
                                          sx={{ fontSize: '0.65rem', fontWeight: 'bold', height: '20px' }}
                                        />
                                        
                                        {/* Effort Estimation Indicator */}
                                        {idea.estimatedEffort && (
                                          <Chip 
                                            label={`${idea.estimatedEffort}${idea.effortUnit === 'story_points' ? 'SP' : 'MD'}`}
                                            size="small"
                                            color="info"
                                            sx={{ fontSize: '0.65rem', fontWeight: 'bold', height: '20px' }}
                                          />
                                        )}
                                        
                                        {/* Requirements Indicator */}
                                        {idea.detailedRequirements && idea.detailedRequirements.trim() && (
                                          <Chip 
                                            label="üìã Reqs"
                                            size="small"
                                            color="warning"
                                            sx={{ fontSize: '0.65rem', height: '20px' }}
                                          />
                                        )}
                                        
                                        {/* Scheduled Quarter Chip in Kanban */}
                                        {idea.promoted && idea.plannedRelease && (
                                          <Chip 
                                            label={`üìÖ ${idea.plannedRelease}`}
                                            size="small"
                                            color="success"
                                            variant="filled"
                                            sx={{ 
                                              fontSize: '0.65rem', 
                                              height: '20px',
                                              fontWeight: 'bold',
                                              backgroundColor: 'success.main',
                                              color: 'success.contrastText'
                                            }}
                                          />
                                        )}

                                        {/* Azure DevOps Work Item ID Chip */}
                                        {idea.promoted && idea.azureWorkItem?.id && (
                                          <Chip 
                                            label={`üîó #${idea.azureWorkItem.id}`}
                                            size="small"
                                            color="primary"
                                            variant="outlined"
                                            clickable
                                            onClick={() => {
                                              // Construct the correct Azure DevOps URL
                                              const orgUrl = new URL(idea.azureWorkItem.organizationUrl || 'https://dev.azure.com/yourorg');
                                              const project = encodeURIComponent(idea.azureWorkItem.project || 'VisionSuite');
                                              const url = `${orgUrl.origin}${orgUrl.pathname.replace(/\/$/, '')}/${project}/_workitems/edit/${idea.azureWorkItem.id}`;
                                              window.open(url, '_blank');
                                            }}
                                            sx={{ 
                                              fontSize: '0.65rem', 
                                              height: '20px',
                                              fontWeight: 'bold',
                                              cursor: 'pointer'
                                            }}
                                            title={`Click to open Azure DevOps work item #${idea.azureWorkItem.id}`}
                                          />
                                        )}
                                      </Box>

                                      {/* Features Tags - Compact */}
                                      {idea.features && idea.features.length > 0 && (
                                        <Box sx={{ mb: 0.75 }}>
                                          <Typography variant="caption" color="text.secondary" sx={{ fontSize: '0.65rem', mb: 0.25, display: 'block' }}>
                                            Features:
                                          </Typography>
                                          <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.25 }}>
                                            {idea.features.slice(0, 3).map((feature, index) => (
                                              <Chip 
                                                key={index}
                                                label={feature.length > 15 ? `${feature.substring(0, 15)}...` : feature}
                                                size="small"
                                                variant="filled"
                                                color="primary"
                                                sx={{ fontSize: '0.6rem', height: '18px' }}
                                              />
                                            ))}
                                            {idea.features.length > 3 && (
                                              <Chip 
                                                label={`+${idea.features.length - 3} more`}
                                                size="small"
                                                variant="outlined"
                                                color="primary"
                                                sx={{ fontSize: '0.6rem', height: '18px' }}
                                              />
                                            )}
                                          </Box>
                                        </Box>
                                      )}
                                    </Box>
                                  </CardContent>

                                  <CardActions sx={{ pt: 0, pb: 1, px: 1.5, justifyContent: 'space-between' }}>
                                    {/* Left side - Vote and Comment badges */}
                                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                      {/* Vote Badge */}
                                      <Badge 
                                        badgeContent={idea.voteCount || 0} 
                                        color="primary"
                                        sx={{
                                          '& .MuiBadge-badge': {
                                            fontSize: '0.65rem',
                                            height: 16,
                                            minWidth: 16,
                                            fontWeight: 'bold'
                                          }
                                        }}
                                      >
                                        <IconButton
                                          size="small"
                                          sx={{ 
                                            color: idea.voteCount > 0 ? 'primary.main' : 'text.secondary',
                                            p: 0.25
                                          }}
                                        >
                                          <ThumbUpIcon fontSize="small" />
                                        </IconButton>
                                      </Badge>
                                      
                                      {/* Comment Badge */}
                                      <Badge 
                                        badgeContent={idea.title.includes('@Mentions') ? 2 : (idea.title.includes('AI') ? 1 : 0)} 
                                        color="secondary"
                                        sx={{
                                          '& .MuiBadge-badge': {
                                            fontSize: '0.65rem',
                                            height: 16,
                                            minWidth: 16,
                                            fontWeight: 'bold'
                                          }
                                        }}
                                      >
                                        <IconButton
                                          size="small"
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            alert(`Comments for: ${idea.title}`);
                                          }}
                                          sx={{ 
                                            color: 'secondary.main',
                                            p: 0.25,
                                            '&:hover': {
                                              backgroundColor: 'secondary.light',
                                              color: 'secondary.contrastText'
                                            }
                                          }}
                                        >
                                          <CommentIcon fontSize="small" />
                                        </IconButton>
                                      </Badge>
                                    </Box>

                                    {/* Right side - Promote button (only for approved items) and date */}
                                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                      {idea.status === 'approved' && (
                                        <Button
                                          size="small"
                                          startIcon={<RocketIcon />}
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            setPromoteIdea(idea);
                                          }}
                                          className="promote-button"
                                          sx={{ fontSize: '0.7rem' }}
                                        >
                                          Promote
                                        </Button>
                                      )}
                                      
                                      <Typography variant="caption" color="text.secondary">
                                        {formatDate(idea.createdAt)}
                                      </Typography>
                                    </Box>
                                  </CardActions>
                                </Card>
                                ) : (
                                  <Box
                                    ref={provided.innerRef}
                                    {...provided.draggableProps}
                                    onClick={(e) => handleCardClick(idea, e)}
                                    sx={{
                                      mb: 1,
                                      p: 2,
                                      backgroundColor: 'background.paper',
                                      border: '1px solid',
                                      borderColor: 'divider',
                                      borderRadius: 1,
                                      cursor: snapshot.isDragging ? 'grabbing' : 'pointer',
                                      opacity: snapshot.isDragging ? 0.9 : 1,
                                      transition: snapshot.isDragging ? 'none' : 'all 0.2s ease',
                                      '&:hover': {
                                        backgroundColor: 'action.hover',
                                        borderColor: 'primary.main'
                                      },
                                      userSelect: 'none'
                                    }}
                                  >
                                    {/* Drag Handle */}
                                    <Box
                                      {...provided.dragHandleProps}
                                      sx={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: 1,
                                        mb: 1
                                      }}
                                    >
                                      <DragIcon fontSize="small" color="action" />
                                      <Typography 
                                        variant="subtitle1" 
                                        sx={{ 
                                          fontWeight: 600, 
                                          flexGrow: 1,
                                          fontSize: '0.95rem',
                                          lineHeight: 1.3,
                                          color: 'text.primary'
                                        }}
                                      >
                                        {idea.title}
                                      </Typography>
                                    </Box>
                                    
                                    {/* Brief Description */}
                                    {idea.description && (
                                      <Typography 
                                        variant="body2" 
                                        sx={{ 
                                          fontSize: '0.8rem',
                                          color: 'text.secondary',
                                          mb: 1,
                                          lineHeight: 1.4,
                                          display: '-webkit-box',
                                          WebkitLineClamp: 2,
                                          WebkitBoxOrient: 'vertical',
                                          overflow: 'hidden'
                                        }}
                                      >
                                        {idea.description}
                                      </Typography>
                                    )}
                                    
                                    {/* Compact Info Row */}
                                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, flexWrap: 'wrap' }}>
                                      <Chip 
                                        label={idea.category?.split(' - ').pop() || 'No Category'}
                                        size="small"
                                        variant="outlined"
                                        sx={{ 
                                          fontSize: '0.75rem',
                                          fontWeight: 500,
                                          height: '22px'
                                        }}
                                      />
                                      <Badge badgeContent={idea.voteCount || 0} color="primary">
                                        <ThumbUpIcon fontSize="small" />
                                      </Badge>
                                      <Badge badgeContent={commentCounts[idea.id] || 0} color="secondary">
                                        <CommentIcon fontSize="small" />
                                      </Badge>
                                      {idea.attachments && idea.attachments.length > 0 && (
                                        <Badge badgeContent={idea.attachments.length} color="info">
                                          <AttachIcon fontSize="small" />
                                        </Badge>
                                      )}
                                      
                                      {/* Scheduled Quarter Chip in List View */}
                                      {idea.promoted && idea.plannedRelease && (
                                        <Chip 
                                          label={`üìÖ ${idea.plannedRelease}`}
                                          size="small"
                                          color="success"
                                          variant="filled"
                                          sx={{ 
                                            fontSize: '0.65rem', 
                                            height: '20px',
                                            fontWeight: 'bold',
                                            backgroundColor: 'success.main',
                                            color: 'success.contrastText'
                                          }}
                                        />
                                      )}

                                      {/* Azure DevOps Work Item ID Chip in List View */}
                                      {idea.promoted && idea.azureWorkItem?.id && (
                                        <Chip 
                                          label={`üîó #${idea.azureWorkItem.id}`}
                                          size="small"
                                          color="primary"
                                          variant="outlined"
                                          clickable
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            // Construct the correct Azure DevOps URL
                                            const orgUrl = new URL(idea.azureWorkItem.organizationUrl || 'https://dev.azure.com/yourorg');
                                            const project = encodeURIComponent(idea.azureWorkItem.project || 'VisionSuite');
                                            const url = `${orgUrl.origin}${orgUrl.pathname.replace(/\/$/, '')}/${project}/_workitems/edit/${idea.azureWorkItem.id}`;
                                            window.open(url, '_blank');
                                          }}
                                          sx={{ 
                                            fontSize: '0.65rem', 
                                            height: '20px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer'
                                          }}
                                          title={`Click to open Azure DevOps work item #${idea.azureWorkItem.id}`}
                                        />
                                      )}
                                    </Box>
                                  </Box>
                                )
                              )}
                            </Draggable>
                          ))}
                          {provided.placeholder}
                        </Box>
                      )}
                    </Droppable>
                  </Paper>
                </Grid>
              );
            })}
          </Grid>
        )}
      </Droppable>
    </Box>
  </Box>

  {/* Parking Lot Tab */}
  <Droppable droppableId="parking_lot_tab" type="CARD">
    {(provided, snapshot) => (
      <Box
        ref={provided.innerRef}
        {...provided.droppableProps}
        sx={{
          position: 'fixed',
          right: showParkingLot ? 320 : 0,
          top: '50%',
          transform: 'translateY(-50%)',
          zIndex: theme.zIndex.drawer,
          transition: theme.transitions.create(['right', 'background-color'], {
            easing: theme.transitions.easing.sharp,
            duration: theme.transitions.duration.leavingScreen,
          }),
          backgroundColor: snapshot.isDraggingOver ? 'rgba(211, 47, 47, 0.3)' : 'transparent',
          borderRadius: '8px 0 0 8px',
          p: '4px 0 4px 4px',
        }}
      >
          <Button
            variant="contained"
            color={snapshot.isDraggingOver ? 'primary' : 'error'}
            onClick={() => setShowParkingLot(!showParkingLot)}
            startIcon={<ParkingIcon />}
            sx={{
              minWidth: 'auto',
              width: '40px',
              height: '40px',
              borderRadius: '50%',
              p: 0,
              minHeight: '40px',
              position: 'relative',
              overflow: 'visible',
              '& .MuiButton-startIcon': {
                margin: 0
              }
            }}
          >
            <Box 
              component="span" 
              sx={{ 
                position: 'absolute',
                top: -5,
                right: -5,
                backgroundColor: 'white',
                borderRadius: '50%',
                width: 20,
                height: 20,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '0.7rem',
                fontWeight: 'bold',
                color: 'error.main',
                border: '2px solid',
                borderColor: 'error.main'
              }}
            >
              {getIdeasByStatus('parking_lot').length}
            </Box>
          </Button>
          {provided.placeholder}
        </Box>
      )}
    </Droppable>

      {/* Parking Lot Drawer Content */}
      <Box
        sx={{
          position: 'fixed',
          right: showParkingLot ? 0 : -320,
          top: 0,
          width: 320,
          height: '100vh',
          bgcolor: 'background.paper',
          boxShadow: 3,
          zIndex: theme.zIndex.drawer - 1,
          transition: theme.transitions.create(['right'], {
            easing: theme.transitions.easing.sharp,
            duration: theme.transitions.duration.leavingScreen,
          }),
          display: 'flex',
          flexDirection: 'column',
          borderLeft: `1px solid ${theme.palette.divider}`
        }}
      >
        <Box 
          sx={{ 
            p: 2, 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center',
            borderBottom: `1px solid ${theme.palette.divider}`,
            bgcolor: theme.palette.error.main,
            color: theme.palette.error.contrastText
          }}
        >
          <Typography variant="h6" component="div" sx={{ display: 'flex', alignItems: 'center' }}>
            <ParkingIcon sx={{ mr: 1 }} />
            Parking Lot
            <Chip 
              label={getIdeasByStatus('parking_lot').length} 
              color="default" 
              size="small" 
              sx={{ ml: 1, bgcolor: 'rgba(255,255,255,0.2)' }} 
            />
          </Typography>
          <IconButton 
            onClick={() => setShowParkingLot(false)}
            color="inherit"
            size="small"
          >
            <CloseIcon />
          </IconButton>
        </Box>
        <Box sx={{ p: 2, overflowY: 'auto', height: '100%' }}>
          <Droppable droppableId="declined" type="CARD">
            {(provided, snapshot) => (
              <Box
                ref={provided.innerRef}
                {...provided.droppableProps}
                sx={{
                  minHeight: '100%',
                  backgroundColor: snapshot.isDraggingOver ? 'rgba(244, 67, 54, 0.1)' : 'transparent',
                  border: snapshot.isDraggingOver ? '2px dashed #f44336' : '2px dashed transparent',
                  borderRadius: 2,
                  p: 1,
                  transition: 'all 0.2s ease',
                }}
              >
                {getIdeasByStatus('declined').map((idea, index) => (
                  <Draggable 
                    key={`idea-${idea.id}`} 
                    draggableId={`idea-${idea.id}`} 
                    index={index}
                  >
                    {(provided, snapshot) => (
                      <Card
                        ref={provided.innerRef}
                        {...provided.draggableProps}
                        onClick={(e) => handleCardClick(idea, e)}
                        sx={{
                          mb: 2,
                          cursor: snapshot.isDragging ? 'grabbing' : 'pointer',
                          transform: snapshot.isDragging ? 'rotate(1deg) scale(1.01)' : 'none',
                          boxShadow: snapshot.isDragging ? 8 : 1,
                          opacity: snapshot.isDragging ? 0.9 : 1,
                          border: `1px solid ${statusColumns.declined.color}40`,
                          '&:hover': {
                            boxShadow: 3,
                            transform: 'translateY(-2px)'
                          },
                          transition: 'all 0.2s ease',
                        }}
                      >
                        <CardContent sx={{ p: 2 }}>
                          <Typography variant="subtitle2" noWrap>
                            {idea.title}
                          </Typography>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', mt: 1 }}>
                            <Chip 
                              label={formatDate(idea.createdAt)} 
                              size="small" 
                              variant="outlined"
                            />
                            <Box {...provided.dragHandleProps} sx={{ cursor: 'grab' }}>
                              <DragIcon fontSize="small" />
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    )}
                  </Draggable>
                ))}
                {provided.placeholder}
                {getIdeasByStatus('declined').length === 0 && (
                  <Box sx={{ 
                    textAlign: 'center', 
                    p: 3, 
                    color: 'text.secondary',
                    border: '1px dashed rgba(0,0,0,0.1)',
                    borderRadius: 1,
                    my: 2
                  }}>
                    <ParkingIcon sx={{ fontSize: 40, opacity: 0.5, mb: 1 }} />
                    <Typography variant="body2">
                      Drag items here to move them to the parking lot
                    </Typography>
                  </Box>
                )}
              </Box>
            )}
          </Droppable>
        </Box>
      </Box>

      {/* Mobile FAB for Parking Lot */}
      <Fab
        color="error"
        aria-label="parking-lot"
        onClick={() => setShowParkingLot(!showParkingLot)}
        sx={{
          position: 'fixed',
          bottom: 24,
          right: 24,
          zIndex: theme.zIndex.speedDial,
          boxShadow: theme.shadows[8],
          '&:hover': {
            transform: 'scale(1.1)',
            boxShadow: theme.shadows[12],
          },
          transition: 'all 0.2s ease',
          display: { xs: 'flex', md: 'none' },
        }}
      >
        {showParkingLot ? <CloseIcon /> : <ParkingIcon />}
        <Box
          sx={{
            position: 'absolute',
            top: -8,
            right: -8,
            backgroundColor: 'white',
            borderRadius: '50%',
            width: 24,
            height: 24,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '0.75rem',
            fontWeight: 'bold',
            color: 'error.main',
            border: '2px solid',
            borderColor: 'error.main'
          }}
        >
          {getIdeasByStatus('declined').length}
        </Box>
      </Fab>

        {/* Admin Idea Detail Dialog */}
        <AdminIdeaDetailDialog
          idea={selectedIdea}
          open={!!selectedIdea}
          onClose={() => setSelectedIdea(null)}
          onIdeaUpdated={handleIdeaUpdated}
          settings={settings}
        />

        {/* Promote Idea Dialog */}
        <PromoteIdeaDialog
          idea={promoteIdea}
          open={!!promoteIdea}
          onClose={() => setPromoteIdea(null)}
          onIdeaPromoted={handleIdeaPromoted}
        />

        {/* Settings Dialog */}
        <SettingsDialog
          open={showSettings}
          onClose={() => setShowSettings(false)}
          onSettingsUpdated={handleSettingsUpdated}
        />

        {/* Roadmap Report Dialog */}
        <RoadmapReportDialog
          open={showRoadmapReport}
          onClose={() => setShowRoadmapReport(false)}
          ideas={allIdeas}
          currentFilters={filters}
        />

        {/* Excel Import Dialog */}
        <ExcelImportDialog
          open={showExcelImport}
          onClose={() => setShowExcelImport(false)}
          onImportSuccess={() => {
            fetchIdeas(); // Refresh ideas after successful import
            setShowExcelImport(false);
          }}
        />

              sx={{
                position: 'fixed',
                right: showParkingLot ? 320 : 0,
                top: '50%',
                transform: 'translateY(-50%)',
                zIndex: theme.zIndex.drawer,
                transition: theme.transitions.create(['right', 'background-color'], {
                  easing: theme.transitions.easing.sharp,
                  duration: theme.transitions.duration.leavingScreen,
                }),
                backgroundColor: snapshot.isDraggingOver ? 'rgba(211, 47, 47, 0.3)' : 'transparent',
                borderRadius: '8px 0 0 8px',
                p: '4px 0 4px 4px',
              }}
            >
              <Button
                variant="contained"
                color={snapshot.isDraggingOver ? 'primary' : 'error'}
                onClick={() => setShowParkingLot(!showParkingLot)}
                startIcon={<ParkingIcon />}
                sx={{
                  minWidth: 'auto',
                  width: '40px',
                  height: '40px',
                  borderRadius: '50%',
                  p: 0,
                  minHeight: '40px',
                  position: 'relative',
                  overflow: 'visible',
                  '& .MuiButton-startIcon': {
                    margin: 0
                  }
                }}
              >
                <Box 
                  component="span" 
                  sx={{ 
                    position: 'absolute',
                    top: -5,
                    right: -5,
                    backgroundColor: 'white',
                    borderRadius: '50%',
                    width: 20,
                    height: 20,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '0.7rem',
                    fontWeight: 'bold',
                    color: 'error.main',
                    border: '2px solid',
                    borderColor: 'error.main'
                  }}
                >
                  {getIdeasByStatus('parking_lot').length}
                </Box>
              </Button>
              {provided.placeholder}
            </Box>
          )}
        </Droppable>

        {/* Parking Lot Drawer */}
        <Drawer
          anchor="right"
          open={showParkingLot}
          onClose={() => setShowParkingLot(false)}
          sx={{
            '& .MuiDrawer-paper': {
              width: 320,
              boxSizing: 'border-box',
            },
          }}
        >
          <Box sx={{ p: 2, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Typography variant="h6">Parking Lot</Typography>
            <IconButton onClick={() => setShowParkingLot(false)}>
              <CloseIcon />
            </IconButton>
          </Box>
          <Divider />
          <Box sx={{ p: 2, overflowY: 'auto', flexGrow: 1 }}>
            {getIdeasByStatus('parking_lot').map((idea, index) => (
              <Card key={idea._id} sx={{ mb: 2 }}>
                <CardContent>
                  <Typography variant="subtitle1">{idea.title}</Typography>
                  <Typography variant="body2" color="text.secondary">
                    {idea.description}
                  </Typography>
                </CardContent>
              </Card>
            ))}
            {getIdeasByStatus('parking_lot').length === 0 && (
              <Typography variant="body2" color="text.secondary" sx={{ textAlign: 'center', mt: 2 }}>
                No items in parking lot
              </Typography>
            )}
          </Box>
        </Drawer>
      </Box>
    </DragDropContext>
  );
};

export default ProductTeamDashboard;
